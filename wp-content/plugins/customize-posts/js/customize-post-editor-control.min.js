!function(t,e){"use strict";var o=!0;t.Posts.PostEditorControl=t.controlConstructor.dynamic.extend({initialize:function(o,n){var i,s=this;_.bindAll(s,"handleRemoval","onTextEditorChange","onVisualEditorChange","onMousedownEditorDragbar","onMouseupEditorDragbar","resizeEditorWithWindowResize","updateEditorContentsOnSettingChange","handleSectionExpansionToggled","handleToggleEditorButtonClick"),(i={}).params=_.extend({type:"post_editor",section:"",priority:25,label:t.Posts.data.l10n.fieldContentLabel,active:!0,setting_property:null,input_attrs:{}},n.params||{}),s.expanded=new t.Value(!1),s.expandedArgumentsQueue=[],s.expanded.bind(function(t){var o=s.expandedArgumentsQueue.shift();o=e.extend({},s.defaultExpandedArguments,o),s.onChangeExpanded(t,o)}),t.controlConstructor.dynamic.prototype.initialize.call(s,o,i),s.deferred.embedded.done(function(){s.initEditor()}),t.control.bind("remove",s.handleRemoval)},handleRemoval:function(o){var n,i,s=this;s===o&&(i=t.section(s.section()),t.control.unbind("remove",s.handleRemoval),s.expanded.set(!1),s.container.remove(),(n=tinyMCE.get("customize-posts-content"))&&n.off("input change keyup",s.onVisualEditorChange),s.contentTextarea.off("input",s.onTextEditorChange),s.setting&&s.setting.unbind(s.updateEditorContentsOnSettingChange),i&&i.expanded.unbind(s.handleSectionExpansionToggled),s.editorToggleExpandButton.off("click",s.handleToggleEditorButtonClick),s.editorDragbar.off("mousedown",s.onMousedownEditorDragbar),s.editorDragbar.off("mouseup",s.onMouseupEditorDragbar),e(window).off("resize",s.resizeEditorWithWindowResize))},_toggleExpanded:function(e,o){var n=this;return e&&n.section()&&t.section.has(n.section())&&t.section(n.section()).expand(),t.Section.prototype._toggleExpanded.call(n,e,o)},expand:t.Section.prototype.expand,collapse:t.Section.prototype.collapse,onChangeExpanded:function(t,n){var i,s,a=this,d=a.setting;s=a.params.setting_property?d.get()[a.params.setting_property]:d.get(),i=tinyMCE.get("customize-posts-content"),a.updateEditorToggleExpandButtonLabel(t),t?(a.collapseOtherControls(),a.updateEditorHeading(),o&&i.show(),i&&o?i.setContent(wp.editor.autop(s)):a.contentTextarea.val(s),i.on("input change keyup",a.onVisualEditorChange),a.contentTextarea.on("input",a.onTextEditorChange),e("#wp-customize-posts-content-wrap").on("keydown",a.stopEscKeypressEventPropagation),e(document.body).addClass("customize-posts-content-editor-pane-open"),a.resizeEditor(window.innerHeight-a.editorPane.height())):(a.editorHeading.text(""),i.off("input change keyup",a.onVisualEditorChange),a.contentTextarea.off("input",a.onTextEditorChange),e("#wp-customize-posts-content-wrap").off("keydown",a.stopEscKeypressEventPropagation),e(document.body).removeClass("customize-posts-content-editor-pane-open"),e(".mce-active").click(),o=!i.isHidden(),i.hide(),a.customizePreview.css("bottom",""),a.collapseSidebar.css("bottom","")),n&&n.completeCallback&&n.completeCallback()},updateEditorHeading:function(){var e,o=this,n=0;(e=t.section(o.section()))&&_.each(e.controls(),function(e){e.extended(t.Posts.PostEditorControl)&&(n+=1)}),n>1?(o.editorHeading.text(o.params.label),o.editorHeading.show()):(o.editorHeading.text(""),o.editorHeading.hide())},onVisualEditorChange:function(){var t,e,o,n=this;n.editorSyncSuspended||(e=tinyMCE.get("customize-posts-content"),t=wp.editor.removep(e.getContent()),n.editorSyncSuspended=!0,n.params.setting_property?((o=_.clone(n.setting.get()))[n.params.setting_property]=t,n.setting.set(o)):n.setting.set(t),n.editorSyncSuspended=!1)},onTextEditorChange:function(){var t,e,o=this;o.editorSyncSuspended||(t=o.contentTextarea.val(),o.editorSyncSuspended=!0,o.params.setting_property?((e=_.clone(o.setting.get()))[o.params.setting_property]=t,o.setting.set(e)):o.setting.set(t),o.editorSyncSuspended=!1)},initEditor:function(){var o=this,n=t.section(o.section()),i=o.setting;if(1!==_.size(o.settings))throw new Error("Only one setting may be associated with a post editor control.");o.editorHeading=e("#customize-posts-content-editor-title"),o.contentTextarea=e("#customize-posts-content"),o.customizePreview=e("#customize-preview"),o.editorDragbar=e("#customize-posts-content-editor-dragbar"),o.editorPane=e("#customize-posts-content-editor-pane"),o.editorFrame=e("#customize-posts-content_ifr"),o.collapseSidebar=e(".collapse-sidebar"),o.editorToggleExpandButton=o.container.find(".toggle-post-editor"),o.updateEditorToggleExpandButtonLabel(o.expanded.get()),i.bind(o.updateEditorContentsOnSettingChange),n.expanded.bind(o.handleSectionExpansionToggled),o.editorToggleExpandButton.on("click",o.handleToggleEditorButtonClick),o.editorDragbar.on("mousedown",o.onMousedownEditorDragbar),o.editorDragbar.on("mouseup",o.onMouseupEditorDragbar),e(window).on("resize",o.resizeEditorWithWindowResize)},updateEditorContentsOnSettingChange:function(t,e){var o,n=this,i=n.params.setting_property?t[n.params.setting_property]:t,s=n.params.setting_property?e[n.params.setting_property]:e;n.expanded.get()&&!n.editorSyncSuspended&&i!==s&&(n.editorSyncSuspended=!0,(o=tinyMCE.get("customize-posts-content"))&&!o.isHidden()?o.setContent(wp.editor.autop(i)):n.contentTextarea.val(i),n.editorSyncSuspended=!1)},handleSectionExpansionToggled:function(e){var o=this,n=t.section(o.section());n&&e?t.Posts.postIdInput.val(n.params.post_id||!1):(t.Posts.postIdInput.val(""),o.expanded.set(!1))},handleToggleEditorButtonClick:function(){var t=this,e=tinyMCE.get("customize-posts-content");t.expanded.set(!t.expanded()),t.expanded()&&(e?e.focus():t.contentTextarea.focus())},onMousedownEditorDragbar:function(){var t=this;t.expanded()&&e(document).on("mousemove.customize-posts-editor",function(o){o.preventDefault(),e(document.body).addClass("customize-posts-content-editor-pane-resize"),t.editorFrame.css("pointer-events","none"),t.resizeEditor(o.pageY)})},onMouseupEditorDragbar:function(){var t=this;t.expanded()&&(e(document).off("mousemove.customize-posts-editor"),e(document.body).removeClass("customize-posts-content-editor-pane-resize"),t.editorFrame.css("pointer-events",""))},resizeEditorWithWindowResize:function(){var t=this;t.expanded()&&_.delay(function(){t.resizeEditor(window.innerHeight-t.editorPane.height())},50)},collapseOtherControls:function(){var e=this;t.control.each(function(o){o!==e&&o.extended(t.Posts.PostEditorControl)&&o.expanded.get()&&o.expanded.set(!1)})},updateEditorToggleExpandButtonLabel:function(e){this.editorToggleExpandButton.text(e?t.Posts.data.l10n.closeEditor:t.Posts.data.l10n.openEditor)},resizeEditor:function(t){var o,n=this,i=window.innerHeight,s=window.innerWidth,a=e("[id^=accordion-panel-posts] ul.accordion-section-content"),d=e("#wp-customize-posts-content-editor-tools"),r=e(".mce-toolbar-grp"),c=e(".mce-statusbar"),p={};n.expanded()&&(_.isNaN(t)||(o=i-t),p.height=o,p.components=d.outerHeight()+r.outerHeight()+c.outerHeight(),o<40&&(p.height=40),o>i-1&&(p.height=i-1),i<n.editorPane.outerHeight()&&(p.height=i),n.customizePreview.css("bottom",p.height),n.editorPane.css("height",p.height),n.editorFrame.css("height",p.height-p.components),n.collapseSidebar.css("bottom",p.height+8),56>i-p.height&&n.collapseSidebar.css("bottom",c.outerHeight()+4),s<=782?a.css("padding-bottom",p.height):a.css("padding-bottom",""))},focus:function(t){var e=this,o=tinyMCE.get("customize-posts-content");e.actuallyEmbed(),e.expand({completeCallback:function(){o?o.focus():e.contentTextarea.focus(),t&&t.completeCallback&&t.completeCallback()}})},stopEscKeypressEventPropagation:function(t){27===t.which&&t.stopPropagation()}}),t.controlConstructor.post_editor=t.Posts.PostEditorControl}(wp.customize,jQuery);