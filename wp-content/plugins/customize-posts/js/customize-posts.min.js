!function(t,e){"use strict";var n;t.Posts||(t.Posts={}),(n=t.Posts).data={postTypes:{},initialServerDate:"",initialServerTimestamp:0,initialClientTimestamp:(new Date).valueOf(),l10n:{sectionCustomizeActionTpl:"",fieldTitleLabel:"",fieldContentLabel:"",fieldExcerptLabel:""},postIdInput:null},n.fetchedPosts={},"undefined"!=typeof _wpCustomizePostsExports&&_.extend(n.data,_wpCustomizePostsExports),t.panelConstructor.posts=n.PostsPanel,t.sectionConstructor.post=n.PostSection,t.controlConstructor.post_discussion_fields=t.controlConstructor.dynamic.extend({initialize:function(e,n){n.params.type="post_discussion_fields",n.params.field_type="checkbox",t.controlConstructor.dynamic.prototype.initialize.call(this,e,n)}}),_.each(n.data.postTypes,function(e){var n,o;n="posts["+e.name+"]",t.panelConstructor[n]||(t.panelConstructor[n]=t.panelConstructor.posts.extend({postType:e})),o="post["+e.name+"]",t.sectionConstructor[o]||(t.sectionConstructor[o]=t.sectionConstructor.post.extend({postType:e}))}),n.parseSettingId=function(t){var e,n={};return"post"!==(e=t.replace(/]/g,"").split("["))[0]&&"postmeta"!==e[0]?null:(n.settingType=e[0],"post"===n.settingType&&3!==e.length||"postmeta"===n.settingType&&4!==e.length?null:(n.postType=e[1],n.postType?(n.postId=parseInt(e[2],10),isNaN(n.postId)||n.postId<=0?null:"postmeta"!==n.settingType||(n.metaKey=e[3],n.metaKey)?n:null):null))},n.getPostUrl=function(n){var o,i;if(o=_.clone(n),!(i=parseInt(o.post_id,10)))throw new Error("Missing post_id param.");return delete o.post_id,o.post_type&&"page"===o.post_type?o.page_id=i:o.p=i,"post"!==n.post_type&&"page"!==n.post_type||delete o.post_type,t.settings.url.home+"?"+e.param(o)},n.getPreviewUrl=function(t){return n.getPostUrl(_.extend({},t,{preview:!0}))},n.insertAutoDraftPost=function(o){var i,s,r=e.Deferred();return i=wp.ajax.post("customize-posts-insert-auto-draft",{"customize-posts-nonce":t.settings.nonce["customize-posts"],wp_customize:"on",post_type:o}),s=function(i){var s,a,p,u;n.addPostSettings(i.settings),i.postSettingId&&t.has(i.postSettingId)?(s=n.addPostSection(i.postSettingId))?(t.control.each(function(e){"dropdown-pages"===e.params.type&&e.container.find('select[name^="_customize-dropdown-pages-"]').append(new Option(t.Posts.data.l10n.noTitle,i.postId))}),t.section.has("static_front_page")&&t.section("static_front_page").activate(),a=new t.Menus.AvailableItemModel({id:"post-"+i.postId,title:t.Posts.data.l10n.noTitle,type:"post_type",type_label:t.Posts.data.postTypes[o].labels.singular_name,object:o,object_id:i.postId,url:t.Posts.getPostUrl({post_id:i.postId,post_type:o})}),t.Menus.availableMenuItemsPanel.collection.add(a),p=e("#available-menu-items-post_type-"+o).find(".available-menu-items-list"),u=wp.template("available-menu-item"),p.prepend(u(a.attributes)),r.resolve({postId:i.postId,section:s,setting:t(i.postSettingId)})):r.reject("no_section"):r.reject("no_setting")},i.done(s),i.fail(function(t){var e=t||"";void 0!==t.message&&(e=t.message),console.error(e),r.reject(e)}),r.promise()},n.receivePreviewData=function(t){var e=n.previewedQuery.get();t.isPartial?((e=_.clone(e)).postIds=e.postIds.concat(t.postIds),n.previewedQuery.set(e)):n.previewedQuery.set(t),n.ensurePosts(n.previewedQuery.get().postIds)},n.gatherFetchedPostsData=function(e){var o={};return _.each(e,function(e){var i,s,r,a;s="nav_menu_item"===(i=n.fetchedPosts[e])?{postType:i,customizeId:r="nav_menu_item["+String(e)+"]",section:(a=t(r))?t.section("nav_menu["+String(a.get().nav_menu_term_id)+"]"):null,setting:a}:i?{postType:i,customizeId:r="post["+i+"]["+String(e)+"]",section:t.section(r),setting:t(r)}:null,o[e]=s}),o},n.ensurePosts=function(o){var i,s,r=e.Deferred();return 0===(s=_.filter(o,function(t){return!n.fetchedPosts[t]})).length?(r.resolve(n.gatherFetchedPostsData(o)),r):((i=wp.ajax.post("customize-posts-fetch-settings",{"customize-posts-nonce":t.settings.nonce["customize-posts"],wp_customize:"on",customized:t.previewer.query().customized,post_ids:s})).done(function(t){n.addPostSettings(t),_.each(t,function(t,e){"post"===t.type&&n.addPostSection(e)}),r.resolve(n.gatherFetchedPostsData(o))}),i.fail(function(){r.reject()}),r.promise())},n.addPostSettings=function(e){var o=[];return _.each(e,function(e,i){var s,r,a,p,u=n.parseSettingId(i);u?(o.push(u.postId),n.fetchedPosts[u.postId]=u.postType,(s=t(i))||(a=!_.isUndefined(t.settingConstructor)&&t.settingConstructor[e.type]?t.settingConstructor[e.type]:t.Setting,delete(p=_.extend({},e,{previewer:t.previewer,dirty:!1})).value,s=new a(i,e.value,p),t.add(i,s),e.dirty&&(s._dirty=!0,s.callbacks.fireWith(s,[s.get(),s.get()])),t.previewer.send("customize-posts-setting",_.extend({id:i},e)))):(r=i.match(/^nav_menu_item\[(-?\d+)]$/))&&(n.fetchedPosts[parseInt(r[1],10)]="nav_menu_item")}),_.unique(o)},n.addPostSection=function(o){var i,s,r,a,p,u,c,d,l;if(!(s=n.parseSettingId(o))||"post"!==s.settingType)throw new Error("Bad setting ID");return(d=n.data.postTypes[s.postType])?d.show_in_customizer?(p="post["+s.postType+"]",a="posts["+s.postType+"]",r="post["+s.postType+"]["+String(s.postId)+"]",t.section.has(r)?t.section(r):(u=t.sectionConstructor[p]||t.sectionConstructor.post,l=d.labels.customize_action||n.data.l10n.sectionCustomizeActionTpl,c=e("<div>").html(l.replace("%s",t.panel(a).params.title)),i=new u(r,{params:{id:r,panel:a,post_type:s.postType,post_id:s.postId,active:!0,customizeAction:c.text()}}),t.section.add(r,i),i)):null:("undefined"!=typeof console&&console.error&&console.error("Unrecognized post type: "+s.postType),null)},n.sanitizeTitleWithDashes=function(t){var n=e.trim(t).toLowerCase();return n=n.replace(/[^a-z0-9\-_]+/g,"-"),n=n.replace(/--+/g,"-"),n=n.replace(/^-+|-+$/g,"")},n.purgeTrash=function(){t.section.each(function(e){e.extended(n.PostSection)&&"trash"===t(e.id).get().post_status&&(e.active.set(!1),e.collapse(),_.each(e.controls(),function(e){e.container.remove(),t.control.remove(e.id)}),t.section.remove(e.id),e.container.remove(),!0===n.previewedQuery.get().isSingular&&t.previewer.previewUrl(t.settings.url.home),t.remove(e.id),delete n.fetchedPosts[e.params.post_id],"page"===e.params.post_type&&e.removeFromDropdownPagesControls())})},n.updateSettingsQuietly=function(e){var n=t.state("saved").get();_.each(e,function(e,n){var o,i=t(n);i&&!_.isEqual(i.get(),e)&&(o=i._dirty,i.set(e),i._dirty=o)}),t.state("saved").set(n)},n.formatDate=function(t){var e;return e=("0000"+t.getFullYear()).substr(-4,4),e+="-"+("00"+(t.getMonth()+1)).substr(-2,2),e+="-"+("00"+t.getDate()).substr(-2,2),e+=" "+("00"+t.getHours()).substr(-2,2),e+=":"+("00"+t.getMinutes()).substr(-2,2),e+=":"+("00"+t.getSeconds()).substr(-2,2)},n.getCurrentTime=function(){var t,e,o;return e=(new Date).valueOf(),t=n.parsePostDate(n.data.initialServerDate),o=e-n.data.initialClientTimestamp,o+=n.data.initialClientTimestamp-n.data.initialServerTimestamp,t.setTime(t.getTime()+o),n.formatDate(t)},n.parsePostDate=function(t){var e=_.map(t.split(/\D/),function(t){return parseInt(t,10)});return new Date(e[0],e[1]-1,e[2],e[3],e[4],e[5])},n.focusControl=function(e){function o(){return!!(i=t.control(e))&&(i.focus(),!0)}var i,s,r,a;o()||(a=e.match(/^post(?:meta)?\[(.+?)]\[(\d+)]/))&&(r="post["+a[1]+"]["+a[2]+"]",(s=t.section(r))&&s.extended(n.PostSection)&&(s.expand(),s.contentsEmbedded.done(function(){_.delay(o,500)})))},n.ensureButtonsOnDropdownPagesControls=function(){t.control.each(n.addActionButtonsToDropdownPagesControl),t.control.bind("add",n.addActionButtonsToDropdownPagesControl)},n.addActionButtonsToDropdownPagesControl=function(t){"dropdown-pages"===t.params.type&&t.deferred.embedded.done(function(){var o,i,s,r,a,p;o=wp.template("customize-posts-dropdown-pages-inputs"),i=e(o()),(s=t.container.find("select")).after(i),i.prepend(s),r=i.find(".edit-page"),a=i.find(".create-page"),(p=function(t){r.toggle(0!==parseInt(t,10))})(t.setting.get()),t.setting.bind(p),r.on("click",function(o){o.preventDefault(),n.startEditPostFlow({postId:parseInt(t.setting.get(),10),initiatingButton:e(this),originatingConstruct:t,restorePreviousUrl:!0,returnToOriginatingConstruct:!0})}),a.on("click",function(o){o.preventDefault(),n.startCreatePostFlow({postType:"page",initiatingButton:e(this),originatingConstruct:t,restorePreviousUrl:!0,returnToOriginatingConstruct:!0,breadcrumbReturnCallback:function(e){"publish"===e.setting.get().post_status&&t.setting.set(e.postId)}})})})},n.startCreatePostFlow=function(e){var o,i,s,r="create_post_failure";if(!(i=_.extend({postType:null,initiatingButton:null,originatingConstruct:null,restorePreviousUrl:!0,returnToOriginatingConstruct:Boolean(e.originatingConstruct),breadcrumbReturnCallback:null},e)).postType)throw new Error("Missing postType");return i.initiatingButton&&i.initiatingButton.prop("disabled",!0),s=t.Posts.data.postTypes[i.postType],o=t.Posts.insertAutoDraftPost(i.postType),i.originatingConstruct&&i.originatingConstruct.notifications&&i.originatingConstruct.notifications.remove(r),o.done(function(e){var o,r,a=e.section,p=null;a.focus(),s.public?(p=t.previewer.previewUrl.get(),t.previewer.previewUrl(t.Posts.getPreviewUrl({post_type:i.postType,post_id:e.postId}))):t.previewer.refresh(),o={},s.supports.title&&(o.post_title=t.Posts.data.l10n.noTitle),e.setting.set(_.extend({},e.setting.get(),o)),i.returnToOriginatingConstruct&&i.originatingConstruct?(i.restorePreviousUrl&&(r=function(){p=null},t.previewer.previewUrl.bind(r)),n.focusConstructWithBreadcrumb(a,i.originatingConstruct).done(function(){i.breadcrumbReturnCallback&&i.breadcrumbReturnCallback(e),i.initiatingButton&&i.initiatingButton.focus(),p&&i.restorePreviousUrl&&(t.previewer.previewUrl.unbind(r),t.previewer.previewUrl(p))})):n.focusFirstSectionControlOnceFocusable(a)}),o.fail(function(){i.originatingConstruct&&i.originatingConstruct.notifications&&i.originatingConstruct.notifications.add(r,new t.Notification(r,{message:t.Posts.data.l10n.createPostFailure}))}),o.always(function(){i.initiatingButton&&i.initiatingButton.prop("disabled",!1)}),o},n.startEditPostFlow=function(e){var o,i;if(!(o=_.extend({postId:null,initiatingButton:null,originatingConstruct:null,restorePreviousUrl:!0,returnToOriginatingConstruct:Boolean(e.originatingConstruct),breadcrumbReturnCallback:null},e)).postId)throw new Error("Missing postId");return o.initiatingButton&&o.initiatingButton.prop("disabled",!0),i=t.Posts.ensurePosts([o.postId]),o.originatingConstruct&&o.originatingConstruct.notifications&&o.originatingConstruct.notifications.remove("edit_post_failure"),i.done(function(e){var i,s,r=null;(i=e[o.postId].section).focus(),o.returnToOriginatingConstruct&&o.originatingConstruct?(r=t.previewer.previewUrl.get(),t.previewer.previewUrl(t.Posts.getPreviewUrl({post_type:e[o.postId].postType,post_id:o.postId})),o.restorePreviousUrl&&(s=function(){r=null},t.previewer.previewUrl.bind(s)),n.focusConstructWithBreadcrumb(i,o.originatingConstruct).done(function(){o.breadcrumbReturnCallback&&o.breadcrumbReturnCallback(e[o.postId]),o.initiatingButton&&o.initiatingButton.focus(),o.restorePreviousUrl&&r&&(t.previewer.previewUrl.unbind(s),t.previewer.previewUrl(r))})):n.focusFirstSectionControlOnceFocusable(i)}),i.fail(function(){o.originatingConstruct&&o.originatingConstruct.notifications&&o.originatingConstruct.notifications.add("edit_post_failure",new t.Notification("edit_post_failure",{message:t.Posts.data.l10n.editPostFailure}))}),i.always(function(){o.initiatingButton&&o.initiatingButton.prop("disabled",!1)}),i},n.focusConstructWithBreadcrumb=function(o,i){var s,r=e.Deferred();return o.focus({completeCallback:function(){o.extended(t.Section)&&_.defer(function(){n.focusFirstSectionControlOnceFocusable(o)})}}),s=function(t){t||(o.expanded.unbind(s),i.focus({completeCallback:function(){r.resolve()}}))},o.expanded.bind(s),r},n.focusFirstSectionControlOnceFocusable=function(e){var n,o,i=e.controls()[0];i&&(n=function(s){s&&(e.active.unbind(n),o=100,_.delay(function(){i.focus({completeCallback:function(){var e=i.container.find("input:first");e.val()===t.Posts.data.l10n.noTitle?e.select():e.focus()}})},o))},e.active.get()?n(!0):e.active.bind(n))},n.preventStaticFrontPageCollision=function(){t("page_for_posts","page_on_front",function(n,o){n.bind(function(t){parseInt(t,10)===parseInt(o.get(),10)&&o.set(0)}),o.bind(function(t){parseInt(t,10)===parseInt(n.get(),10)&&n.set(0)}),t.control("page_for_posts","page_on_front",function(t,i){var s,r;"dropdown-pages"===t.params.type&&"dropdown-pages"===i.params.type&&(s=function(t,e){var n,o;n=parseInt(e,10),o=parseInt(t,10),0!==n&&i.container.find('option[value="'+String(n)+'"]').show(),0!==o&&i.container.find('option[value="'+String(o)+'"]').hide()},r=function(e,n){var o,i;o=parseInt(n,10),i=parseInt(e,10),0!==o&&t.container.find('option[value="'+String(o)+'"]').show(),0!==i&&t.container.find('option[value="'+String(i)+'"]').hide()},e.when(t.deferred.embedded,i.deferred.embedded).done(function(){n.bind(s),s(n.get()),o.bind(r),r(o.get())}))})})},n.ensureAutofocusConstructPosts=function(){var e=[];return _.each(["section","control"],function(o){var i;t.settings.autofocus[o]&&(i=n.parseSettingId(t.settings.autofocus[o]))&&e.push(i.postId)}),e.length>0&&n.ensurePosts(e),e},e("body").on("keydown",function(t){27!==t.which||e(t.target).is("body")||e.contains(e("#customize-controls")[0],t.target)||t.stopImmediatePropagation()}),t.bind("ready",function(){n.postIdInput=e('<input type="hidden" id="post_ID" name="post_ID">'),e("body").append(n.postIdInput),n.previewedQuery=new t.Value,n.previewedQuery.validate=function(t){return _.extend({isSingular:!1,isPostPreview:!1,queriedPostId:0,postIds:[]},t)},n.previewedQuery.set({}),t.previewer.bind("customized-posts",n.receivePreviewData),t.bind("saved",function(t){t.saved_post_setting_values&&n.updateSettingsQuietly(t.saved_post_setting_values),n.purgeTrash()}),t.previewer.bind("edit-post",function(e){t.Posts.ensurePosts([e]).done(function(t){var n=t[e];n&&n.section.focus()})}),n.ensureButtonsOnDropdownPagesControls(),n.preventStaticFrontPageCollision(),t.previewer.bind("focus-control",n.focusControl),n.ensureAutofocusConstructPosts()})}(wp.customize,jQuery);