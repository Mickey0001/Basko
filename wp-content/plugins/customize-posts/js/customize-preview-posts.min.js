!function(e,t){"use strict";e.previewPosts||(e.previewPosts={}),e.previewPosts.data||(e.previewPosts.data={}),e.previewPosts.wpApiModelInstances=_.extend({},e.Events),t(document.body).on("mousedown",function(e){e.shiftKey&&e.preventDefault()}),e.previewPosts.parsePostClassName=function(e){var t,s,i;return(t=e.match(/(\s|^)post-(\d+)(\s|$)/))?(s=parseInt(t[2],10),(t=e.match(/(\s|^)type-(\S+)(\s|$)/))?(i=t[2],{postId:s,postType:i}):null):null},"undefined"!=typeof MutationObserver&&(e.previewPosts.mutationObserver=new MutationObserver(function(s){_.each(s,function(s){var i,r;i=(r=t(s.target)).find(".hentry"),r.is(".hentry")&&(i=i.add(r)),i.each(function(){var i,n;(i=e.previewPosts.parsePostClassName(t(this).prop("className")))&&(n="post["+i.postType+"]["+String(i.postId)+"]",e.previewPosts.ensurePartialsForPostSetting(n),_.each(e.previewPosts.partialSchema(n),function(i){var n;(n=e.selectiveRefresh.partial(i.id))&&_.each(n.placements(),function(i){(r.is(i.container)||t.contains(s.target,i.container[0]))&&(t(i.container).attr("title",e.selectiveRefresh.data.l10n.shiftClickToEdit),n.createEditShortcutForPlacement(i))})}))})})}),e.previewPosts.mutationObserver.observe(document.documentElement,{childList:!0,subtree:!0})),e.previewPosts.ensurePartialsForPostSetting=function(s){var i=[],r=/^post\[(.+?)]\[(-?\d+)]\[(.+?)](?:\[(.+?)])?$/;return/^post\[(.+?)]\[(\d+)]$/.test(s.id)?(_.each(e.previewPosts.partialSchema(s.id),function(s){var n,a,o,p,d;if(!(a=s.id.match(r)))throw new Error("Bad PostFieldPartial id. Expected post[:post_type][:post_id][:field_id]");e.selectiveRefresh.partial.has(s.id)||(p=a[1],o=parseInt(a[2],10),s.params.selector?(d=[".hentry.post-"+String(o)],"page"===p?d.push("body.page.page-id-"+String(o)):d.push("body.postid-"+String(o)),s.params.selector=_.map(d,function(e){var t=e+" "+s.params.selector;return t=t.replace(/%d/g,String(o))}).join(", "),n=new e.selectiveRefresh.partialConstructor.post_field(s.id,{params:s.params}),e.selectiveRefresh.partial.add(n.id,n),i.push(n)):((n=new e.selectiveRefresh.partialConstructor.post_field(s.id,{params:s.params})).refresh=function(){var s=t.Deferred();return this.params.fallbackRefresh?(e.selectiveRefresh.requestFullRefresh(),s.resolve()):s.reject(),s.promise()},e.selectiveRefresh.partial.add(n.id,n),i.push(n)))}),i):[]},e.previewPosts.partialSchema=function(t){var s=[];return _.each(e.previewPosts.data.partialSchema,function(i,r){var n,a;a=r.replace(/]/g,"").split(/\[/),n=t+"["+a.join("][")+"]",i.settings=[t],s.push({id:n,params:e.previewPosts.snakeToCamel(i)})}),s},e.previewPosts.snakeToCamel=function(e){var t={};return _.each(e,function(e,s){var i=s.replace(/_\w/g,function(e){return e[1].toUpperCase()});t[i]=e}),t},e.isLinkPreviewable&&(e.isLinkPreviewable=function(e){return function(s,i){return!!t(s).closest("a").hasClass("post-edit-link")||e.call(this,s,i)}}(e.isLinkPreviewable)),e.Preview.prototype.handleLinkClick&&(e.Preview.prototype.handleLinkClick=function(e){return function(s){t(s.target).closest("a").hasClass("post-edit-link")?s.preventDefault():e.call(this,s)}}(e.Preview.prototype.handleLinkClick)),e.previewPosts.injectBackboneModelSync=function(){var t=wp.api.WPApiBaseModel.prototype.initialize,s=!1;wp.customize.bind("active",function(){s=!0}),wp.api.WPApiBaseModel.prototype.initialize=function(i,r){var n,a=this;t.call(a,i,r),i&&-1!==e.previewPosts.data.postTypes.indexOf(i.type)&&(n="post["+i.type+"]["+String(i.id)+"]",e.previewPosts.wpApiModelInstances[n]||(e.previewPosts.wpApiModelInstances[n]=[]),e.previewPosts.wpApiModelInstances[n].push(a),e.previewPosts.wpApiModelInstances.trigger("add",a,n),e(n,function(t){var i=function(t){e.previewPosts.handlePostSettingChangeForBackboneModel(a,t)};s&&i(t.get()),t.bind(i)}))},e.selectiveRefresh.bind("render-partials-response",e.previewPosts.handleRenderPartialsResponse)},e.previewPosts.handlePostSettingChangeForBackboneModel=function(e,t){var s={};_.each(["title","content","excerpt"],function(i){_.isObject(e.get(i))&&(e.get(i).raw&&e.get(i).raw===t["post_"+i]||(s[i]={raw:t["post_"+i],rendered:t["post_"+i]},!s[i].rendered||"excerpt"!==i&&"content"!==i||(s[i].rendered="<p>"+s[i].rendered.split(/\n\n+/).join("</p><p>")+"</p>",s[i].rendered=s[i].rendered.replace(/\n/g,"<br>"))))}),_.each(["author","slug"],function(i){_.isUndefined(e.get(i))||(s[i]=t["post_"+i])}),_.isUndefined(e.get("date"))||(s.date=t.post_date.replace(" ","T")),e.set(s)},e.previewPosts.handleRenderPartialsResponse=function(t){t.rest_post_resources&&_.each(t.rest_post_resources,function(t,s){e.previewPosts.wpApiModelInstances[s]&&_.each(e.previewPosts.wpApiModelInstances[s],function(e){e.set(t)})})},e.bind("preview-ready",function(){_.extend(e.previewPosts.data,_wpCustomizePreviewPostsData),e.previewPosts.data.hasRestApiBackboneClient&&e.previewPosts.injectBackboneModelSync(),e.each(e.previewPosts.ensurePartialsForPostSetting),e.bind("add",e.previewPosts.ensurePartialsForPostSetting),e.preview.bind("customize-posts-setting",function(t){e.has(t.id)||e.create(t.id,t.value,{id:t.id})}),e.preview.bind("active",function(){e.preview.send("customized-posts",{isPostPreview:e.previewPosts.data.isPostPreview,isSingular:e.previewPosts.data.isSingular,queriedPostId:e.previewPosts.data.queriedPostId,postIds:e.previewPosts.data.postIds}),t(document.body).on("click",".post-edit-link",function(s){var i,r;(r=t(this).prop("search").match(/post=(\d+)/))&&(i=parseInt(r[1],10),s.preventDefault(),i&&e.preview.send("edit-post",i))})}),e.selectiveRefresh.bind("render-partials-response",function(t){t.queried_post_ids&&e.preview.send("customized-posts",{postIds:t.queried_post_ids,isPartial:!0})}),t(document).ajaxSuccess(function(t,s,i,r){var n;"POST"===i.type&&-1!==i.url.indexOf("infinity=scrolling")&&(n="string"==typeof r?JSON.parse(r):r).queried_post_ids&&e.preview.send("customized-posts",{postIds:n.queried_post_ids,isPartial:!0})})})}(wp.customize,jQuery);